<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Heart + Firework + Gyro + Parallax Starfield</title>

<style>
/* =====================================================
 * 全畫面 Canvas 設定
 * ===================================================== */
html, body {
  margin: 0;
  height: 100%;
  background: #0b0b10;
  overflow: hidden;
}
canvas {
  display: block;
  width: 100vw;
  height: 100vh;
}
#hint {
  position: fixed;
  bottom: 14px;
  left: 0;
  right: 0;
  text-align: center;
  font: 14px/1.4 system-ui, -apple-system, "Segoe UI";
  color: rgba(255,255,255,0.7);
  pointer-events: none;
  user-select: none;
}
</style>
</head>

<body>
<canvas id="c"></canvas>
<div id="hint"></div>

<script>
(() => {
/* =====================================================
 * 0) Canvas / Context 初始化
 *    - 單一 canvas 同時畫「星空背景」與「粒子愛心」
 * ===================================================== */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d", { alpha: false });
const hint = document.getElementById("hint");

/* =====================================================
 * 1) Retina / Resize 處理
 *    - dpr 限制到 2 避免粒子+星星太吃效能
 * ===================================================== */
let DPR = 1;
function resize(){
  DPR = Math.min(2, devicePixelRatio || 1);
  canvas.width  = innerWidth  * DPR;
  canvas.height = innerHeight * DPR;
  canvas.style.width  = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

  // 視窗大小改變時，重建星空（讓分佈覆蓋整個畫面）
  buildStarfield();
}
addEventListener("resize", resize);

/* =====================================================
 * 2) 參數設定
 * ===================================================== */
const CFG = {
  // 粒子愛心
  count: 3200,
  heartScale: 13,
  beatAmp: 0.08,
  beatSpeed: 1.8,

  // 匯聚（3 秒）
  gatherTime: 3.0,
  attract: 0.0011,
  swirlStrength: 3.2,
  swirlDecayExp: 2.4,
  damping: 0.90,

  // 爆炸
  burstPower: 7.5,
  burstScatter: 2.5,

  // 閃爍
  sparkleRate: 0.065,

  // 背景
  bg: "#0b0b10",

  // 星空視差
  starCount: 240,         // 星空粒子數（越大越密）
  starTwinkle: 0.55,      // 星星閃爍幅度
  parallaxMax: 65         // 視差最大位移（px）
};

/* =====================================================
 * 3) 陀螺儀：主要影響「愛心位置漂移」+ 星空視差
 * ===================================================== */
let tiltX = 0, tiltY = 0;        // -1..1
let motionEnabled = false;

function smooth(v, t, a=0.15){ return v + (t - v) * a; }

function onOrientation(e){
  const g = e.gamma ?? 0; // 左右
  const b = e.beta  ?? 0; // 前後
  tiltX = smooth(tiltX, Math.max(-1, Math.min(1, g / 35)));
  tiltY = smooth(tiltY, Math.max(-1, Math.min(1, b / 35)));
}

async function enableMotion(){
  if (motionEnabled) return;
  if (typeof DeviceOrientationEvent?.requestPermission === "function"){
    try{
      const res = await DeviceOrientationEvent.requestPermission();
      if (res === "granted"){
        addEventListener("deviceorientation", onOrientation);
        motionEnabled = true;
        hint.textContent = "";
      } else {
        hint.textContent = "未授權陀螺儀，仍可點擊看煙火。";
      }
    } catch {
      hint.textContent = "陀螺儀授權失敗，仍可點擊看煙火。";
    }
  } else {
    addEventListener("deviceorientation", onOrientation);
    motionEnabled = true;
    hint.textContent = "";
  }
}

if (typeof DeviceOrientationEvent?.requestPermission === "function"){
  hint.textContent = "Tap to enable motion（iPhone 陀螺儀 + 視差星空）";
}

/* =====================================================
 * 4) 視差星空（Parallax Starfield）
 *    設計概念：
 *    - 每顆星有一個 depth（0..1）
 *      depth 越小：越遠 → 移動越少、亮度較低、尺寸較小
 *      depth 越大：越近 → 移動越多、亮度較高、尺寸較大
 *    - 傾斜手機時，用 (tiltX, tiltY) 去偏移星的位置
 * ===================================================== */
let stars = [];

function rand(a,b){ return a + Math.random()*(b-a); }

function buildStarfield(){
  stars = [];
  const w = innerWidth, h = innerHeight;

  // 依畫面面積調整星數（避免超大螢幕太稀）
  const area = w * h;
  const targetCount = Math.round(CFG.starCount * Math.min(1.35, Math.max(0.75, area / (900*700))));

  for(let i=0;i<targetCount;i++){
    const depth = Math.pow(Math.random(), 1.6);  // 偏向遠星（depth 小）
    stars.push({
      x: Math.random()*w,
      y: Math.random()*h,
      depth,                 // 0..1
      seed: Math.random()*1000
    });
  }
}

/* =====================================================
 * 5) 心形方程 + 粒子初始化
 * ===================================================== */
function heart(t){
  return {
    x: 16 * Math.sin(t) ** 3,
    y: 13 * Math.cos(t)
       - 5 * Math.cos(2*t)
       - 2 * Math.cos(3*t)
       - Math.cos(4*t)
  };
}

const P = [];
function buildHeartParticles(){
  P.length = 0;
  for (let i=0;i<CFG.count;i++){
    const t = Math.random() * Math.PI * 2;
    const h = heart(t);
    const k = Math.sqrt(Math.random()); // 讓內部更自然
    P.push({
      bx: h.x * k,
      by: -h.y * k,
      x: (Math.random()-0.5)*innerWidth*1.8,
      y: (Math.random()-0.5)*innerHeight*1.8,
      vx: 0, vy: 0,
      seed: Math.random()*1000,
      hue: 340
    });
  }
}

/* =====================================================
 * 6) 狀態機：gather / heart / burst
 * ===================================================== */
let mode = "gather";
let stateStart = performance.now();

/* =====================================================
 * 7) 點擊：七彩煙火爆炸 + iOS 授權
 * ===================================================== */
addEventListener("pointerdown", async ()=>{
  await enableMotion();
  if (mode === "burst") return;

  mode = "burst";
  stateStart = performance.now();

  // 以「愛心中心」向外噴
  const cx = centerX, cy = centerY;
  for (const p of P){
    const dx = p.x - cx;
    const dy = p.y - cy;
    const len = Math.hypot(dx,dy) || 1;

    p.vx = (dx/len + (Math.random()-0.5)*CFG.burstScatter) * CFG.burstPower;
    p.vy = (dy/len + (Math.random()-0.5)*CFG.burstScatter) * CFG.burstPower;
    p.hue = Math.random()*360;
  }
});

/* =====================================================
 * 8) 愛心中心「漂移慣性」
 *    - 這是你指定的主要互動方向
 * ===================================================== */
let centerX = innerWidth/2;
let centerY = innerHeight/2;

/* =====================================================
 * 9) 顏色：粉紅→白鑽閃（心形/匯聚）
 * ===================================================== */
function pinkDiamondColor(spark){
  const hue = 340;
  const sat = Math.max(0, 100 - spark*90);
  const light = 56 + spark*32;
  const alpha = 0.35 + spark*0.65;
  return { hue, sat, light, alpha };
}

/* =====================================================
 * 10) 星空繪製函數（含視差 + 閃爍）
 * ===================================================== */
function drawStarfield(time){
  // 視差偏移：由 tiltX/tiltY 決定，最大位移 CFG.parallaxMax
  const px = tiltX * CFG.parallaxMax;
  const py = tiltY * CFG.parallaxMax;

  for(const s of stars){
    // depth 小（遠）→ 位移小；depth 大（近）→ 位移大
    const par = 0.15 + s.depth * 0.85;

    const x = s.x + px * par;
    const y = s.y + py * par;

    // 星星閃爍（用 sin + seed）
    const tw = 0.55 + 0.45 * Math.sin(time*0.9 + s.seed);
    const alpha = (0.10 + 0.55 * par) * (0.55 + tw*CFG.starTwinkle);

    // 尺寸：近星稍大、遠星稍小
    const r = 0.45 + par * 1.35;

    // 讓星星邊緣更柔：用白色但透明度不同
    ctx.fillStyle = `rgba(255,255,255,${Math.min(1, alpha)})`;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI*2);
    ctx.fill();
  }
}

/* =====================================================
 * 11) 主動畫迴圈
 * ===================================================== */
let last = performance.now();
function draw(now){
  const dt = Math.min(0.033, (now-last)/1000);
  last = now;

  // 11-1) 清背景
  ctx.fillStyle = CFG.bg;
  ctx.fillRect(0,0,innerWidth,innerHeight);

  // 11-2) 畫視差星空（先畫背景，再畫愛心）
  const time = now*0.001;
  drawStarfield(time);

  // 11-3) 計算愛心中心：由陀螺儀控制「主要漂移」
  const baseCX = innerWidth/2;
  const baseCY = innerHeight/2;

  // 目標中心：傾斜越大，偏移越大
  const targetCX = baseCX + tiltX * 80;
  const targetCY = baseCY + tiltY * 80;

  // 慣性跟隨（漂移手感）
  centerX += (targetCX - centerX) * 0.08;
  centerY += (targetCY - centerY) * 0.08;

  // 11-4) 心跳縮放
  const beat = 1 + Math.sin(time*CFG.beatSpeed*2*Math.PI) * CFG.beatAmp;
  const scale = CFG.heartScale * beat;

  // 狀態時間
  const st = (now - stateStart)/1000;

  // 11-5) 心形微光暈（讓整體更立體）
  const glowR = Math.min(innerWidth, innerHeight) * 0.20 * beat;
  const g = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, glowR);
  g.addColorStop(0, "rgba(255, 220, 235, 0.12)");
  g.addColorStop(0.45, "rgba(255, 80, 140, 0.08)");
  g.addColorStop(1, "rgba(255, 45, 111, 0.00)");
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(centerX, centerY, glowR, 0, Math.PI*2);
  ctx.fill();

  // 11-6) 更新/繪製愛心粒子
  for(const p of P){
    const tx = centerX + p.bx * scale;
    const ty = centerY + p.by * scale;

    if(mode === "gather"){
      // 匯聚：吸引 + 漩渦（漩渦不再強依賴陀螺儀，保持穩定）
      const dx = tx - p.x;
      const dy = ty - p.y;
      const dist = Math.hypot(dx,dy) + 1e-6;

      // 垂直方向（用於漩渦）
      const nx = -dy/dist;
      const ny =  dx/dist;

      // 漩渦隨時間衰減，最後自然貼合
      const swirl = CFG.swirlStrength * Math.exp(-st * CFG.swirlDecayExp);

      p.vx += dx*CFG.attract + nx*swirl*0.03;
      p.vy += dy*CFG.attract + ny*swirl*0.03;

      p.x += p.vx;
      p.y += p.vy;

      p.vx *= CFG.damping;
      p.vy *= CFG.damping;

      p.hue = 340;

      if(st >= CFG.gatherTime){
        mode = "heart";
        stateStart = now;
      }
    }
    else if(mode === "heart"){
      // 穩定停在心形位置
      p.x += (tx - p.x)*0.16;
      p.y += (ty - p.y)*0.16;
      p.hue = 340;
    }
    else if(mode === "burst"){
      // 七彩煙火爆炸
      p.x += p.vx;
      p.y += p.vy;
      p.vx *= 0.90;
      p.vy *= 0.90;

      // 爆炸維持約 1.2 秒後重新匯聚
      if(st > 1.2){
        mode = "gather";
        stateStart = now;
        p.hue = 340;
      }
    }

    // 閃爍
    const spark = Math.random() < CFG.sparkleRate
      ? 0.70 + Math.random()*0.30
      : 0.15*Math.abs(Math.sin(time*4 + p.seed));

    // 粒子大小
    const r = 0.75 + spark*2.1;

    // 顏色：心形(粉→白) / 爆炸(七彩)
    let fill;
    if(mode === "burst"){
      fill = `hsla(${p.hue},100%,${50+spark*35}%,${0.35+spark*0.65})`;
    } else {
      const c = pinkDiamondColor(spark);
      fill = `hsla(${c.hue},${c.sat}%,${c.light}%,${c.alpha})`;
    }

    ctx.fillStyle = fill;
    ctx.beginPath();
    ctx.arc(p.x, p.y, r, 0, Math.PI*2);
    ctx.fill();
  }

  requestAnimationFrame(draw);
}

/* =====================================================
 * 12) 啟動
 *    - 先建星空、再建愛心粒子、再開始動畫
 * ===================================================== */
function start(){
  resize();
  buildHeartParticles();
  requestAnimationFrame(draw);
}
start();
})();
</script>
</body>
</html>
